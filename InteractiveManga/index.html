<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>マンガ見開きページ V21（P5コマ割り追加／P4ズーム#5）</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Helvetica Neue', Arial, 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif; background: linear-gradient(135deg, #f0e6d2 0%, #e6d7c3 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; overflow-x: hidden; }

    /* 本体 */
    .book-container { position: relative; width: 1040px; height: 690px; perspective: 1500px; }
    .spread { position: absolute; width: 100%; height: 100%; display: flex; opacity: 0; visibility: hidden; transition: opacity .5s, visibility .5s; }
    .spread.active { opacity: 1; visibility: visible; }
    .page { width: 520px; height: 690px; position: relative; background: #fffcf9; overflow: hidden; }
    .page.left  { box-shadow: inset -10px 0 20px rgba(0,0,0,.1), -2px 0 5px rgba(0,0,0,.05); border-right: 1px solid rgba(0,0,0,.05); }
    .page.right { box-shadow: inset 10px 0 20px rgba(0,0,0,.1),  2px 0 5px rgba(0,0,0,.05); border-left:  1px solid rgba(0,0,0,.05); }
    .spread::after { content: ''; position: absolute; left: 50%; top: 0; width: 20px; height: 100%; transform: translateX(-50%); background: linear-gradient(to right, transparent, rgba(0,0,0,.2) 30%, rgba(0,0,0,.3) 50%, rgba(0,0,0,.2) 70%, transparent); pointer-events: none; z-index: 10; }
    .page.empty { background: transparent; box-shadow: none; border: none; }

    /* 共通 */
    .manga-page { width: 100%; height: 100%; border: 3px solid #000; background: #fff; padding: 20px; position: relative; }
    .page-number { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); font-size: 14px; color: #666; font-weight: 500; background: #fff; padding: 2px 8px; border-radius: 10px; }
    .koma { position: relative; border: 3px solid #000; overflow: hidden; background: #fafafa; }
    .koma img.koma-img-el { position:absolute; inset:0; width:100%; height:100%; object-fit: cover; display:block; }
    .asset-badge { position: absolute; right: 8px; bottom: 8px; z-index: 4; background: rgba(0,0,0,.75); color:#fff; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: 600; letter-spacing: .02em; }

    /* ===== ページ1（上2スクエア＋下全面） ===== */
    .layout-p1v2 { height: 100%; display: flex; flex-direction: column; gap: 15px; }
    .layout-p1v2 .row.top { display: flex; gap: 15px; }
    .layout-p1v2 .row.top .koma { flex: 1 1 0; aspect-ratio: 1 / 1; }
    .layout-p1v2 .row.bottom { flex: 1 1 0; min-height: 0; }
    .layout-p1v2 .row.bottom .koma { height: 100%; }

    /* ===== ページ2（添付レイアウト） ===== */
    .layout-p2v2 { height: 100%; display: flex; flex-direction: column; gap: 12px; }
    .layout-p2v2 .row { display: flex; gap: 12px; }
    .layout-p2v2 .row.top { flex: 1.2 1 0; }
    .layout-p2v2 .row.top .koma { flex: 1 1 0; height: 100%; }
    .layout-p2v2 .row.mid { flex: 1 1 0; }
    .layout-p2v2 .row.mid .left   { flex: 2.2 1 0; }
    .layout-p2v2 .row.mid .thin   { flex: 0.55 1 0; }
    .layout-p2v2 .row.mid .right  { flex: 1.25 1 0; }
    .layout-p2v2 .row.mid .koma   { height: 100%; }
    .layout-p2v2 .row.bottom { flex: 1 1 0; }
    .layout-p2v2 .row.bottom .koma { flex: 1 1 0; height: 100%; }

    /* ===== ページ3（横2段：上1・下1） ===== */
    .layout-p3v2 { height: 100%; display: flex; flex-direction: column; gap: 14px; }
    .layout-p3v2 .row { display: flex; min-height: 0; }
    .layout-p3v2 .row.top { flex: 3 1 0; }
    .layout-p3v2 .row.bottom { flex: 2 1 0; }
    .layout-p3v2 .koma { flex: 1 1 0; height: 100%; }

    /* ===== ページ4（ページ全体 2列×3行・右#5は2行スパン） ===== */
    .layout-p4v2 { --g: 16px; height: 100%; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: repeat(3, 1fr); gap: var(--g); }
    .layout-p4v2 .k1 { grid-area: 1 / 1 / 2 / 2; }
    .layout-p4v2 .k2 { grid-area: 1 / 2 / 2 / 3; }
    .layout-p4v2 .k3 { grid-area: 2 / 1 / 3 / 2; }
    .layout-p4v2 .k4 { grid-area: 3 / 1 / 4 / 2; }
    .layout-p4v2 .k5 { grid-area: 2 / 2 / 4 / 3; min-height: 0; }
    .layout-p4v2 .koma { height: 100%; }

    /* ===== ページ5（上2× 下2× ＋ 最下段ワイド1） ===== */
    .layout-p5 { height: 100%; display: flex; flex-direction: column; gap: 14px; }
    .layout-p5 .row { display: flex; gap: 14px; min-height: 0; }
    .layout-p5 .row.top { flex: 1 1 0; }
    .layout-p5 .row.mid { flex: 1 1 0; }
    .layout-p5 .row.top .koma, .layout-p5 .row.mid .koma { flex: 1 1 0; aspect-ratio: 1 / 1; }
    .layout-p5 .row.bottom { flex: 1 1 0; }
    .layout-p5 .row.bottom .koma { height: 100%; flex: 1 1 0; }

    /* ===== ページ6（上3スクエア／中段ワイド1／下2スクエア） ===== */
    .layout-p6 { --g: 16px; height: 100%; display: flex; flex-direction: column; gap: var(--g); }
    .layout-p6 .row { display: flex; gap: var(--g); min-height: 0; }
    .layout-p6 .row.top .koma { flex: 1 1 0; aspect-ratio: 1 / 1; }
    .layout-p6 .row.mid { flex: 1 1 0; }
    .layout-p6 .row.mid .koma { flex: 1 1 0; height: 100%; }
    .layout-p6 .row.bottom .koma { flex: 1 1 0; aspect-ratio: 1 / 1; }

    /* ===== ページ7（上：左ワイド＋右スクエア／中：フルワイド／下：2スクエア） ===== */
    .layout-p7 { --g: 16px; height: 100%; display: flex; flex-direction: column; gap: var(--g); }
    .layout-p7 .row { display: flex; gap: var(--g); min-height: 0; }
    .layout-p7 .row.top { flex: 0 0 auto; }
    .layout-p7 .row.top .left  { flex: 2 1 0; aspect-ratio: 16 / 10; }
    .layout-p7 .row.top .right { flex: 1 1 0; aspect-ratio: 1 / 1; }
    .layout-p7 .row.mid { flex: 1 1 0; }
    .layout-p7 .row.mid .koma { flex: 1 1 0; height: 100%; }
    .layout-p7 .row.bottom { flex: 0 0 auto; }
    .layout-p7 .row.bottom .koma { flex: 1 1 0; aspect-ratio: 1 / 1; }

    /* ===== ページ7（上：左縦／右横広、中央：2枚＝等幅、下：フルワイド）===== */
    .layout-p7b { --g: 16px; height: 100%; display: flex; flex-direction: column; gap: var(--g); }
    .layout-p7b .row { display: grid; gap: var(--g); min-height: 0; }
    .layout-p7b .row.top { grid-template-columns: 1fr 2fr; flex: 1 1 0; }
    .layout-p7b .row.mid { grid-template-columns: 1fr 1fr; flex: 1 1 0; }
    .layout-p7b .row.bottom { flex: 1.4 1 0; }
    .layout-p7b .row .koma { height: 100%; }

    /* --- ページ8の微調整: mid を少し高く、bottom を少し低く --- */
    [data-page="8"].layout-p7 .row.bottom .koma { aspect-ratio: 11 / 10; }

    /* ===== ページ9（上：2スクエア／中：左細・右ワイド／下：2スクエア） ===== */
    .layout-p9 { --g: 16px; height: 100%; display: flex; flex-direction: column; gap: var(--g); }
    .layout-p9 .row { display: grid; gap: var(--g); min-height: 0; }
    .layout-p9 .row.top    { grid-template-columns: 1fr 1fr; }
    .layout-p9 .row.top .koma, .layout-p9 .row.bottom .koma { aspect-ratio: 1 / 1; }
    .layout-p9 .row.mid    { grid-template-columns: 1fr 2fr; flex: 1 1 0; }
    .layout-p9 .row.mid .koma { height: 100%; }
    .layout-p9 .row.bottom { grid-template-columns: 1fr 1fr; }

    /* --- ページ9の微調整: 中段を少し高く、下段を少し低く --- */
    [data-page="9"].layout-p9 .row.mid { flex: 1.3 1 0; }
    [data-page="9"].layout-p9 .row.bottom .koma { aspect-ratio: 11 / 10; }

    /* 4ページ目 5コマ目はクリック可能（右縦長） */
    [data-page="4"] .koma[data-koma="5"] { cursor: zoom-in; }

    /* ナビ（inline onclickを廃止 → JSで付与） */
    .nav-area { position: absolute; top:0; height:100%; width:50px; cursor:pointer; z-index:20; transition: background-color .3s; }
    .nav-area:hover { background-color: rgba(0,0,0,.05); }
    .nav-area.prev { right:0; }
    .nav-area.next { left:0; }
    .nav-area::after { content:''; position:absolute; top:50%; transform:translateY(-50%); width:0; height:0; border-style: solid; opacity:0; transition: opacity .3s; }
    .nav-area:hover::after { opacity:.5; }
    .nav-area.prev::after { right:15px; border-width:15px 0 15px 20px; border-color: transparent transparent transparent #333; }
    .nav-area.next::after { left:15px; border-width:15px 20px 15px 0; border-color: transparent #333 transparent transparent; }

    /* ===== ズーム＆AIボット ===== */
    #bookRoot { transform-origin: var(--zoom-origin-x) var(--zoom-origin-y); }
    #bookRoot.zooming-in { animation: cameraZoomIn .7s ease-out forwards; }
    #bookRoot.zooming-out { animation: cameraZoomOut .7s ease-out forwards; }

    @keyframes cameraZoomIn { 0% { transform: scale(1); filter: blur(0px); } 100% { transform: scale(25); filter: blur(8px); } }
    @keyframes cameraZoomOut { 0% { transform: scale(25); filter: blur(8px); } 100% { transform: scale(1); filter: blur(0px); } }

    .zoom-overlay { position: fixed; inset: 0; background: #000; opacity: 0; pointer-events: none; z-index: 30; transition: opacity .6s ease-out; }
    .zoom-overlay.active { opacity: 1; pointer-events: auto; }

    .ai-bot-wrapper { position: fixed; inset: 0; z-index: 40; display: none; opacity: 0; transition: opacity .5s ease; }
    .ai-bot-wrapper.active { display: block; opacity: 1; }

    .ai-bot-container { width: 100%; height: 100%; position: relative; background: #1a1a2e; }
    .image-background { position: absolute; inset: 0; display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); grid-auto-rows: 120px; gap: 2px; padding: 2px; opacity: .3; overflow: hidden; }
    .bg-image-cell { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; position: relative; overflow: hidden; }
    .bg-image-cell::before { content: '🤖'; position: absolute; inset: 0; display:flex; align-items:center; justify-content:center; font-size: 40px; opacity: .6; }
    .bg-image-cell:nth-child(2n)::before { content: '💬'; }
    .bg-image-cell:nth-child(3n)::before { content: '🎨'; }
    .bg-image-cell:nth-child(4n)::before { content: '✨'; }
    .bg-image-cell:nth-child(5n)::before { content: '🚀'; }
    .bg-image-cell:nth-child(6n)::before { content: '💡'; }
    .bg-image-cell:nth-child(7n)::before { content: '🌟'; }

    .ai-response-area { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; max-width: 800px; max-height: 60vh; background: rgba(20,20,30,.9); border-radius: 20px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,.3); display: none; overflow-y: auto; }
    .ai-response-area.show { display: block; }
    .ai-response-text { font-size: 18px; line-height: 1.6; color: #fff; word-wrap: break-word; }

    .input-area { position: absolute; left: 0; right: 0; bottom: 0; background: linear-gradient(to top, rgba(26,26,46, .98), rgba(26,26,46, .9)); padding: 20px; border-top: 2px solid rgba(255,255,255,.1); }
    .input-container { max-width: 800px; margin: 0 auto; display: flex; gap: 10px; }
    .text-input { flex: 1; padding: 15px 20px; font-size: 16px; border: 2px solid rgba(255,255,255,.2); border-radius: 30px; background: rgba(255,255,255,.1); color: #fff; outline: none; transition: all .3s; }
    .text-input::placeholder { color: rgba(255,255,255,.5); }
    .text-input:focus { border-color: #667eea; background: rgba(255,255,255,.15); }
    .submit-btn { padding: 15px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; border-radius: 30px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all .3s; white-space: nowrap; }
    .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102,126,234,.4); }
    .submit-btn:disabled { opacity: .5; cursor: not-allowed; transform: none; }

    .back-btn { position: fixed; top: 20px; right: 40px; color: white; font-size: 40px; font-weight: bold; cursor: pointer; opacity: 0; z-index: 45; transition: opacity .3s; pointer-events: none; background: rgba(0,0,0,.3); width: 50px; height: 50px; border-radius: 50%; display:flex; align-items:center; justify-content:center; }
    .back-btn.visible { opacity: .85; pointer-events: auto; }
    .back-btn:hover { transform: scale(1.08); background: rgba(0,0,0,.5); }
  </style>
</head>
<body>
  <div class="book-container" id="bookRoot">
    <!-- 見開き1（表紙） -->
    <div class="spread has-empty active" data-spread="1">
      <div class="page left">
        <div class="cover-container" id="front-cover" data-asset="cover_front">
          <img class="cover-image koma-img-el" alt="cover_front" data-name="cover_front" src=""
               onload="this.style.display='block'; this.parentElement.classList.add('has-image');"
               onerror="this.style.display='none';" />
          <span class="asset-badge">cover_front</span>
          <div class="cover-placeholder">表紙</div>
        </div>
        <div class="nav-area next"></div>
      </div>
      <div class="page right empty"></div>
    </div>

    <!-- 見開き2：ページ1 + 表紙裏（※テキスト削除） -->
    <div class="spread" data-spread="2">
      <div class="page left">
        <div class="manga-page layout-p1v2" data-page="1">
          <div class="row top">
            <div class="koma" data-koma="1" data-asset="p1_koma1">
              <img class="koma-img-el" alt="p1_koma1" data-name="p1_koma1" src="" />
              <span class="asset-badge">p1_koma1</span>
            </div>
            <div class="koma" data-koma="2" data-asset="p1_koma2">
              <img class="koma-img-el" alt="p1_koma2" data-name="p1_koma2" src="" />
              <span class="asset-badge">p1_koma2</span>
            </div>
          </div>
          <div class="row bottom">
            <div class="koma" data-koma="3" data-asset="p1_koma3">
              <img class="koma-img-el" alt="p1_koma3" data-name="p1_koma3" src="" />
              <span class="asset-badge">p1_koma3</span>
            </div>
          </div>
          <div class="page-number">1</div>
        </div>
        <div class="nav-area next"></div>
      </div>
      <div class="page right">
        <div class="front-inside">
          <div class="qr-code-area" aria-label="QR"></div>
        </div>
        <div class="nav-area prev"></div>
      </div>
    </div>

    <!-- 見開き3：ページ3（左：横2段） + ページ2（右） -->
    <div class="spread" data-spread="3">
      <div class="page left">
        <div class="manga-page layout-p3v2" data-page="3">
          <div class="row top">
            <div class="koma" data-koma="1" data-asset="p3_koma1">
              <img class="koma-img-el" alt="p3_koma1" data-name="p3_koma1" src="" />
              <span class="asset-badge">p3_koma1</span>
            </div>
          </div>
          <div class="row bottom">
            <div class="koma" data-koma="2" data-asset="p3_koma2">
              <img class="koma-img-el" alt="p3_koma2" data-name="p3_koma2" src="" />
              <span class="asset-badge">p3_koma2</span>
            </div>
          </div>
          <div class="page-number">3</div>
        </div>
        <div class="nav-area next"></div>
      </div>
      <div class="page right">
        <div class="manga-page layout-p2v2" data-page="2">
          <div class="row top">
            <div class="koma full" data-koma="3" data-asset="p2_koma3">
              <img class="koma-img-el" alt="p2_koma3" data-name="p2_koma3" src="" />
              <span class="asset-badge">p2_koma3</span>
            </div>
          </div>
          <div class="row mid">
            <div class="koma left" data-koma="1" data-asset="p2_koma1">
              <img class="koma-img-el" alt="p2_koma1" data-name="p2_koma1" src="" />
              <span class="asset-badge">p2_koma1</span>
            </div>
            <div class="koma thin" data-koma="6" data-asset="p2_koma6">
              <img class="koma-img-el" alt="p2_koma6" data-name="p2_koma6" src="" />
              <span class="asset-badge">p2_koma6</span>
            </div>
            <div class="koma right" data-koma="2" data-asset="p2_koma2">
              <img class="koma-img-el" alt="p2_koma2" data-name="p2_koma2" src="" />
              <span class="asset-badge">p2_koma2</span>
            </div>
          </div>
          <div class="row bottom">
            <div class="koma" data-koma="4" data-asset="p2_koma4">
              <img class="koma-img-el" alt="p2_koma4" data-name="p2_koma4" src="" />
              <span class="asset-badge">p2_koma4</span>
            </div>
            <div class="koma" data-koma="5" data-asset="p2_koma5">
              <img class="koma-img-el" alt="p2_koma5" data-name="p2_koma5" src="" />
              <span class="asset-badge">p2_koma5</span>
            </div>
          </div>
          <div class="page-number">2</div>
        </div>
        <div class="nav-area prev"></div>
      </div>
    </div>

    <!-- 見開き4：ページ5（左：新レイアウト） + ページ4（右・既存） -->
    <div class="spread" data-spread="4">
      <div class="page left">
        <div class="manga-page layout-p5" data-page="5">
          <div class="row top">
            <div class="koma" data-koma="1" data-asset="p5_koma1">
              <img class="koma-img-el" alt="p5_koma1" data-name="p5_koma1" src="" />
              <span class="asset-badge">p5_koma1</span>
            </div>
            <div class="koma" data-koma="2" data-asset="p5_koma2">
              <img class="koma-img-el" alt="p5_koma2" data-name="p5_koma2" src="" />
              <span class="asset-badge">p5_koma2</span>
            </div>
          </div>
          <div class="row mid">
            <div class="koma" data-koma="3" data-asset="p5_koma3">
              <img class="koma-img-el" alt="p5_koma3" data-name="p5_koma3" src="" />
              <span class="asset-badge">p5_koma3</span>
            </div>
            <div class="koma" data-koma="4" data-asset="p5_koma4">
              <img class="koma-img-el" alt="p5_koma4" data-name="p5_koma4" src="" />
              <span class="asset-badge">p5_koma4</span>
            </div>
          </div>
          <div class="row bottom">
            <div class="koma" data-koma="5" data-asset="p5_koma5">
              <img class="koma-img-el" alt="p5_koma5" data-name="p5_koma5" src="" />
              <span class="asset-badge">p5_koma5</span>
            </div>
          </div>
          <div class="page-number">5</div>
        </div>
        <div class="nav-area next"></div>
      </div>
      <div class="page right">
        <div class="manga-page layout-p4v2" data-page="4">
          <div class="koma k1" data-koma="1" data-asset="p4_koma1">
            <img class="koma-img-el" alt="p4_koma1" data-name="p4_koma1" src="" />
            <span class="asset-badge">p4_koma1</span>
          </div>
          <div class="koma k2" data-koma="2" data-asset="p4_koma2">
            <img class="koma-img-el" alt="p4_koma2" data-name="p4_koma2" src="" />
            <span class="asset-badge">p4_koma2</span>
          </div>
          <div class="koma k3" data-koma="3" data-asset="p4_koma3">
            <img class="koma-img-el" alt="p4_koma3" data-name="p4_koma3" src="" />
            <span class="asset-badge">p4_koma3</span>
          </div>
          <div class="koma k4" data-koma="4" data-asset="p4_koma4">
            <img class="koma-img-el" alt="p4_koma4" data-name="p4_koma4" src="" />
            <span class="asset-badge">p4_koma4</span>
          </div>
          <div class="koma k5" data-koma="5" data-asset="p4_koma5">
            <img class="koma-img-el" alt="p4_koma5" data-name="p4_koma5" src="" />
            <span class="asset-badge">p4_koma5</span>
          </div>
          <div class="page-number">4</div>
        </div>
        <div class="nav-area prev"></div>
      </div>
    </div>

    <!-- 見開き5：ページ7（左） + ページ6（右） -->
    <div class="spread" data-spread="5">
      <div class="page left">
        <div class="manga-page layout-p7b" data-page="7">
          <div class="row top">
            <div class="koma k1" data-koma="1" data-asset="p7_koma1">
              <img class="koma-img-el" alt="p7_koma1" data-name="p7_koma1" src="" />
              <span class="asset-badge">p7_koma1</span>
            </div>
            <div class="koma k2" data-koma="2" data-asset="p7_koma2">
              <img class="koma-img-el" alt="p7_koma2" data-name="p7_koma2" src="" />
              <span class="asset-badge">p7_koma2</span>
            </div>
          </div>
          <div class="row mid">
            <div class="koma k3" data-koma="3" data-asset="p7_koma3">
              <img class="koma-img-el" alt="p7_koma3" data-name="p7_koma3" src="" />
              <span class="asset-badge">p7_koma3</span>
            </div>
            <div class="koma k4" data-koma="4" data-asset="p7_koma4">
              <img class="koma-img-el" alt="p7_koma4" data-name="p7_koma4" src="" />
              <span class="asset-badge">p7_koma4</span>
            </div>
          </div>
          <div class="row bottom">
            <div class="koma k5" data-koma="5" data-asset="p7_koma5">
              <img class="koma-img-el" alt="p7_koma5" data-name="p7_koma5" src="" />
              <span class="asset-badge">p7_koma5</span>
            </div>
          </div>
          <div class="page-number">7</div>
        </div>
        <div class="nav-area next"></div>
      </div>
      <div class="page right">
        <div class="manga-page layout-p6" data-page="6">
          <div class="row top">
            <div class="koma" data-koma="1" data-asset="p6_koma1">
              <img class="koma-img-el" alt="p6_koma1" data-name="p6_koma1" src="" />
              <span class="asset-badge">p6_koma1</span>
            </div>
            <div class="koma" data-koma="2" data-asset="p6_koma2">
              <img class="koma-img-el" alt="p6_koma2" data-name="p6_koma2" src="" />
              <span class="asset-badge">p6_koma2</span>
            </div>
            <div class="koma" data-koma="3" data-asset="p6_koma3">
              <img class="koma-img-el" alt="p6_koma3" data-name="p6_koma3" src="" />
              <span class="asset-badge">p6_koma3</span>
            </div>
          </div>
          <div class="row mid">
            <div class="koma" data-koma="4" data-asset="p6_koma4">
              <img class="koma-img-el" alt="p6_koma4" data-name="p6_koma4" src="" />
              <span class="asset-badge">p6_koma4</span>
            </div>
          </div>
          <div class="row bottom">
            <div class="koma" data-koma="5" data-asset="p6_koma5">
              <img class="koma-img-el" alt="p6_koma5" data-name="p6_koma5" src="" />
              <span class="asset-badge">p6_koma5</span>
            </div>
            <div class="koma" data-koma="6" data-asset="p6_koma6">
              <img class="koma-img-el" alt="p6_koma6" data-name="p6_koma6" src="" />
              <span class="asset-badge">p6_koma6</span>
            </div>
          </div>
          <div class="page-number">6</div>
        </div>
        <div class="nav-area prev"></div>
      </div>
    </div>

    <!-- 見開き6：ページ9（左） + ページ8（右） -->
    <div class="spread" data-spread="6">
      <div class="page left">
        <div class="manga-page layout-p9" data-page="9">
          <div class="row top">
            <div class="koma" data-koma="1" data-asset="p9_koma1">
              <img class="koma-img-el" alt="p9_koma1" data-name="p9_koma1" src="" />
              <span class="asset-badge">p9_koma1</span>
            </div>
            <div class="koma" data-koma="2" data-asset="p9_koma2">
              <img class="koma-img-el" alt="p9_koma2" data-name="p9_koma2" src="" />
              <span class="asset-badge">p9_koma2</span>
            </div>
          </div>
          <div class="row mid">
            <div class="koma" data-koma="3" data-asset="p9_koma3">
              <img class="koma-img-el" alt="p9_koma3" data-name="p9_koma3" src="" />
              <span class="asset-badge">p9_koma3</span>
            </div>
            <div class="koma" data-koma="4" data-asset="p9_koma4">
              <img class="koma-img-el" alt="p9_koma4" data-name="p9_koma4" src="" />
              <span class="asset-badge">p9_koma4</span>
            </div>
          </div>
          <div class="row bottom">
            <div class="koma" data-koma="5" data-asset="p9_koma5">
              <img class="koma-img-el" alt="p9_koma5" data-name="p9_koma5" src="" />
              <span class="asset-badge">p9_koma5</span>
            </div>
            <div class="koma" data-koma="6" data-asset="p9_koma6">
              <img class="koma-img-el" alt="p9_koma6" data-name="p9_koma6" src="" />
              <span class="asset-badge">p9_koma6</span>
            </div>
          </div>
          <div class="page-number">9</div>
        </div>
        <div class="nav-area next"></div>
      </div>
      <div class="page right">
        <div class="manga-page layout-p7" data-page="8">
          <div class="row top">
            <div class="koma left" data-koma="1" data-asset="p8_koma1">
              <img class="koma-img-el" alt="p8_koma1" data-name="p8_koma1" src="" />
              <span class="asset-badge">p8_koma1</span>
            </div>
            <div class="koma right" data-koma="2" data-asset="p8_koma2">
              <img class="koma-img-el" alt="p8_koma2" data-name="p8_koma2" src="" />
              <span class="asset-badge">p8_koma2</span>
            </div>
          </div>
          <div class="row mid">
            <div class="koma" data-koma="3" data-asset="p8_koma3">
              <img class="koma-img-el" alt="p8_koma3" data-name="p8_koma3" src="" />
              <span class="asset-badge">p8_koma3</span>
            </div>
          </div>
          <div class="row bottom">
            <div class="koma" data-koma="4" data-asset="p8_koma4">
              <img class="koma-img-el" alt="p8_koma4" data-name="p8_koma4" src="" />
              <span class="asset-badge">p8_koma4</span>
            </div>
            <div class="koma" data-koma="5" data-asset="p8_koma5">
              <img class="koma-img-el" alt="p8_koma5" data-name="p8_koma5" src="" />
              <span class="asset-badge">p8_koma5</span>
            </div>
          </div>
          <div class="page-number">8</div>
        </div>
        <div class="nav-area prev"></div>
      </div>
    </div>

    <!-- 見開き7：裏表紙 -->
    <div class="spread has-empty" data-spread="7">
      <div class="page left empty"></div>
      <div class="page right">
        <div class="cover-container" id="back-cover" data-asset="cover_back">
          <img class="cover-image koma-img-el" alt="cover_back" data-name="cover_back" src=""
               onload="this.style.display='block'; this.parentElement.classList.add('has-image');"
               onerror="this.style.display='none';" />
          <span class="asset-badge">cover_back</span>
          <div class="cover-placeholder">裏表紙</div>
        </div>
        <div class="nav-area prev"></div>
      </div>
    </div>
  </div>

  <!-- ズーム用オーバーレイ＆AIボット -->
  <div class="zoom-overlay" id="zoomOverlay"></div>
  <div class="ai-bot-wrapper" id="aiBotWrapper">
    <div class="ai-bot-container">
      <div class="image-background" id="imageBackground"></div>
      <div class="ai-response-area" id="aiResponseArea">
        <div class="ai-response-text" id="aiResponseText"></div>
      </div>
      <div class="input-area">
        <div class="input-container">
          <input type="text" class="text-input" id="userInput" placeholder="質問を入力してください…" autocomplete="off" />
          <button class="submit-btn" id="submitBtn" type="button">回答</button>
        </div>
      </div>
    </div>
  </div>
  <span class="back-btn" id="backBtn">&times;</span>

  <!-- ここから下は必ず <script> 内。タイプは module で厳格に読み込み -->
  <script type="module">
    'use strict';

    let currentSpread = 1; const totalSpreads = 7; let isZoomed = false;
    function showSpread(n){ if(isZoomed) return; document.querySelectorAll('.spread').forEach(s=>s.classList.remove('active')); const t=document.querySelector(`[data-spread="${n}"]`); if(t) t.classList.add('active'); currentSpread=n; }
    function nextSpread(){ if(isZoomed) return; if(currentSpread<totalSpreads) showSpread(currentSpread+1); }
    function prevSpread(){ if(isZoomed) return; if(currentSpread>1) showSpread(currentSpread-1); }

    function bindSpreadNav(){
      document.querySelectorAll('.spread .nav-area.next').forEach(el=>{ el.addEventListener('click', nextSpread); });
      document.querySelectorAll('.spread .nav-area.prev').forEach(el=>{ el.addEventListener('click', prevSpread); });
    }

    document.addEventListener('keydown', e=>{ if(isZoomed){ if(e.key==='Escape') zoomOut(); return; } if(e.key==='ArrowLeft') nextSpread(); else if(e.key==='ArrowRight') prevSpread(); });
    let sx=0, ex=0; document.addEventListener('touchstart',e=>{ sx=e.changedTouches[0].screenX; }); document.addEventListener('touchend',e=>{ ex=e.changedTouches[0].screenX; const d=sx-ex; if(Math.abs(d)>50){ if(d>0) nextSpread(); else prevSpread(); } });

    function setCoverImage(type, path){ const c = type==='front' ? document.getElementById('front-cover') : document.getElementById('back-cover'); if(!c) return; const img=c.querySelector('.cover-image'); if(img){ img.src = path || ''; } }
    function renameCoverAsset(type, newName){ const c = type==='front' ? document.getElementById('front-cover') : document.getElementById('back-cover'); if(!c) return; c.setAttribute('data-asset', newName); const img=c.querySelector('.cover-image'); const badge=c.querySelector('.asset-badge'); if(img){ img.setAttribute('data-name', newName); img.alt = newName; } if(badge){ badge.textContent = newName; } }
    function setKomaImage(pageNumber, komaNumber, imagePath){ const pages=[...document.querySelectorAll('.manga-page')].filter(p=>{ const pn=p.querySelector('.page-number'); return pn && Number(pn.textContent)===Number(pageNumber); }); pages.forEach(p=>{ const img = p.querySelector(`.koma[data-koma="${komaNumber}"] img.koma-img-el`); if(img){ img.src = imagePath || ''; } }); }
    function renameKomaAsset(pageNumber, komaNumber, newName){ const pages=[...document.querySelectorAll('.manga-page')].filter(p=>{ const pn=p.querySelector('.page-number'); return pn && Number(pn.textContent)===Number(pageNumber); }); pages.forEach(p=>{ const koma = p.querySelector(`.koma[data-koma="${komaNumber}"]`); if(!koma) return; koma.setAttribute('data-asset', newName); const img = koma.querySelector('img.koma-img-el'); const badge = koma.querySelector('.asset-badge'); if(img){ img.setAttribute('data-name', newName); img.alt = newName; } if(badge){ badge.textContent = newName; } }); }

    const BOOK = document.getElementById('bookRoot');
    const zoomOverlay   = document.getElementById('zoomOverlay');
    const aiBotWrapper  = document.getElementById('aiBotWrapper');
    const backBtn       = document.getElementById('backBtn');

    function generateImageBackground(){ const container=document.getElementById('imageBackground'); container.innerHTML=''; const cellCount=100; for(let i=0;i<cellCount;i++){ const d=document.createElement('div'); d.className='bg-image-cell'; container.appendChild(d);} }

    function zoomIntoKoma(komaEl){
      if(isZoomed) return;
      const rect = komaEl.getBoundingClientRect();
      const bookRect = BOOK.getBoundingClientRect();
      const tweakX = -24; // 左へ微調整
      const cx = (rect.left - bookRect.left) + rect.width/2 + tweakX;
      const cy = (rect.top  - bookRect.top)  + rect.height/2;
      BOOK.style.setProperty('--zoom-origin-x', `${cx}px`);
      BOOK.style.setProperty('--zoom-origin-y', `${cy}px`);
      document.body.style.overflow='hidden';
      BOOK.classList.add('zooming-in');
      zoomOverlay.classList.add('active');
      setTimeout(()=>{
        aiBotWrapper.classList.add('active');
        generateImageBackground();
        const responseArea=document.getElementById('aiResponseArea');
        const responseText=document.getElementById('aiResponseText');
        if(responseArea && responseText){
          responseText.textContent='お待たせ！';
          responseArea.classList.add('show');
        }
        const inputEl=document.getElementById('userInput'); if(inputEl) inputEl.focus();
        backBtn.classList.add('visible');
      }, 600);
      isZoomed=true;
    }

    function zoomOut(){
      if(!isZoomed) return;
      aiBotWrapper.classList.remove('active');
      backBtn.classList.remove('visible');
      BOOK.classList.remove('zooming-in');
      BOOK.classList.add('zooming-out');
      zoomOverlay.classList.remove('active');
      setTimeout(()=>{
        BOOK.classList.remove('zooming-out');
        const resArea=document.getElementById('aiResponseArea');
        const resText=document.getElementById('aiResponseText');
        if(resArea) resArea.classList.remove('show');
        if(resText) resText.textContent='';
        const input=document.getElementById('userInput'); if(input) input.value='';
        isZoomed=false;
        document.body.style.overflow='auto';
      }, 720);
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      bindSpreadNav();
      // P4の#5にズームを割当
      const target=document.querySelector('[data-page="4"] .koma[data-koma="5"]');
      if(target){ target.addEventListener('click', ()=>zoomIntoKoma(target)); }
      const submitBtn = document.getElementById('submitBtn'); if(submitBtn){ submitBtn.addEventListener('click', sendMessage); }
      const closeBtn = document.getElementById('backBtn'); if(closeBtn){ closeBtn.addEventListener('click', zoomOut); }
      const input=document.getElementById('userInput'); if(input){ input.addEventListener('keypress', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); } }); }
    });

    const ANTHROPIC_API_KEY = window.__ANTHROPIC_API_KEY || '';
    const ANTHROPIC_MODEL   = window.__ANTHROPIC_MODEL   || 'claude-3-5-sonnet-20240620';

    async function sendMessage(){
      const input=document.getElementById('userInput');
      const message=(input && input.value || '').trim();
      if(!message) return;
      const submitBtn=document.getElementById('submitBtn');
      const responseArea=document.getElementById('aiResponseArea');
      const responseText=document.getElementById('aiResponseText');
      if(submitBtn){ submitBtn.disabled=true; submitBtn.textContent='処理中'; }
      if(input){ input.disabled=true; }
      if(responseArea){ responseArea.classList.remove('show'); }
      setTimeout(()=>{ if(responseText && responseArea){ responseText.textContent='考え中…'; responseArea.classList.add('show'); } }, 80);
      if(!ANTHROPIC_API_KEY){ if(responseText){ responseText.textContent='APIキーが未設定です。開発者に設定を依頼してください。'; } if(submitBtn){ submitBtn.disabled=false; submitBtn.textContent='回答'; } if(input){ input.disabled=false; } return; }
      try{
        const res = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST', headers: { 'content-type': 'application/json', 'x-api-key': ANTHROPIC_API_KEY, 'anthropic-version': '2023-06-01' },
          body: JSON.stringify({ model: ANTHROPIC_MODEL, max_tokens: 1000, messages: [{ role: 'user', content: message }] })
        });
        if(!res.ok){ throw new Error('Claude API request failed'); }
        const data = await res.json();
        const aiResponse = (data && data.content && data.content[0] && (data.content[0].text || data.content[0].content)) || '（応答の解析に失敗しました）';
        if(responseText){ responseText.textContent = aiResponse; }
      }catch(err){ console.error(err); if(responseText){ responseText.textContent='エラーが発生しました。時間をおいて再度お試しください。'; } }
      finally{
        if(submitBtn){ submitBtn.disabled=false; submitBtn.textContent='回答'; }
        if(input){ input.disabled=false; input.value=''; input.focus(); }
      }
    }

    // 画像パスを自動設定する関数
    function initializeImages() {
      // 表紙画像を設定
      setCoverImage('front', 'Image/cover_front.png');

      // 各ページのコマ画像を設定
      setKomaImage(1, 1, 'Image/p1_koma1.png');
      setKomaImage(1, 2, 'Image/p1_koma2.png');
      setKomaImage(1, 3, 'Image/p1_koma3.png');

      setKomaImage(2, 1, 'Image/p2_koma1.png');
      setKomaImage(2, 2, 'Image/p2_koma2.png');
      setKomaImage(2, 3, 'Image/p2_koma3.png');
      setKomaImage(2, 4, 'Image/p2_koma4.png');
      setKomaImage(2, 5, 'Image/p2_koma5.png');
      setKomaImage(2, 6, 'Image/p2_koma6.png');

      setKomaImage(3, 1, 'Image/p3_koma1.png');
      setKomaImage(3, 2, 'Image/p3_koma2.png');

      setKomaImage(4, 1, 'Image/p4_koma1.png');
      setKomaImage(4, 2, 'Image/p4_koma2.png');
      setKomaImage(4, 3, 'Image/p4_koma3.png');
      setKomaImage(4, 4, 'Image/p4_koma4.png');
      setKomaImage(4, 5, 'Image/p4_koma5.png');

      setKomaImage(5, 1, 'Image/p5_koma1.png');
      setKomaImage(5, 2, 'Image/p5_koma2.png');
      setKomaImage(5, 3, 'Image/p5_koma3.png');
      setKomaImage(5, 4, 'Image/p5_koma4.png');
      setKomaImage(5, 5, 'Image/p5_koma5.png');

      setKomaImage(6, 1, 'Image/p6_koma1.png');
      setKomaImage(6, 2, 'Image/p6_koma2.png');
      setKomaImage(6, 3, 'Image/p6_koma3.png');
      setKomaImage(6, 4, 'Image/p6_koma4.png');
      setKomaImage(6, 5, 'Image/p6_koma5.png');
      setKomaImage(6, 6, 'Image/p6_koma6.png');

      setKomaImage(7, 1, 'Image/p7_koma1.png');
      setKomaImage(7, 2, 'Image/p7_koma2.png');
      setKomaImage(7, 3, 'Image/p7_koma3.png');
      setKomaImage(7, 4, 'Image/p7_koma4.png');
      setKomaImage(7, 5, 'Image/p7_koma5.png');

      setKomaImage(8, 1, 'Image/p8_koma1.png');
      setKomaImage(8, 2, 'Image/p8_koma2.png');
      setKomaImage(8, 3, 'Image/p8_koma3.png');
      setKomaImage(8, 4, 'Image/p8_koma4.png');
      setKomaImage(8, 5, 'Image/p8_koma5.png');

      setKomaImage(9, 1, 'Image/p9_koma1.png');
      setKomaImage(9, 2, 'Image/p9_koma2.png');
      setKomaImage(9, 3, 'Image/p9_koma3.png');
      setKomaImage(9, 4, 'Image/p9_koma4.png');
      setKomaImage(9, 5, 'Image/p9_koma5.png');
      setKomaImage(9, 6, 'Image/p9_koma6.png');
    }

    // 画像を初期化してから初期表示：表紙
    initializeImages();
    showSpread(1);
  </script>
</body>
</html>
